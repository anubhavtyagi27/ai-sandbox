{% extends "base.html" %} {% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <h2 class="mb-4">AI Model API Tester</h2>
        <p class="lead text-muted">
            Test and experiment with different AI providers through a unified
            interface
        </p>

        <!-- Provider Selection -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-cloud"></i> Select AI Provider
                </h5>
            </div>
            <div class="card-body">
                <form method="GET" action="/" id="providerForm">
                    <div class="row align-items-end">
                        <div class="col-md-8">
                            <label for="provider" class="form-label fw-bold">
                                AI Provider
                            </label>
                            {{ provider_form.provider(class="form-select
                            form-select-lg") }}
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-arrow-repeat"></i> Switch
                                Provider
                            </button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Currently using:
                            <strong
                                >{{ available_providers.get(selected_provider,
                                selected_provider) }}</strong
                            >
                        </small>
                    </div>
                </form>
            </div>
        </div>

        <!-- API Form -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">API Parameters</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="/" id="apiForm">
                    {{ form.hidden_tag() }}

                    <!-- Hidden provider field to maintain selection on POST -->
                    <input
                        type="hidden"
                        name="provider"
                        value="{{ selected_provider }}"
                    />

                    <!-- Model Selection -->
                    <div class="mb-3">
                        <label for="model" class="form-label">
                            {{ form.model.label }}
                            <span class="text-danger">*</span>
                        </label>
                        {{ form.model }} {% if form.model.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.model.errors[0] }}
                        </div>
                        {% endif %}
                    </div>

                    <!-- System Instruction File Path -->
                    <div class="mb-3">
                        <label for="system_instruction_file" class="form-label">
                            {{ form.system_instruction_file.label }}
                        </label>
                        {{ form.system_instruction_file }} {% if
                        form.system_instruction_file.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.system_instruction_file.errors[0] }}
                        </div>
                        {% endif %}
                        <div class="form-text">
                            Path to markdown file with system instructions. Once
                            set, it will be remembered for future requests.
                        </div>
                    </div>

                    <!-- Input Mode Selection -->
                    <div class="mb-3">
                        <label class="form-label d-block"
                            >{{ form.input_mode.label }}</label
                        >
                        {% for subfield in form.input_mode %}
                        <div class="form-check form-check-inline">
                            {% if subfield.data == 'voice' %} {{
                            subfield(class="form-check-input", disabled=true) }}
                            {{ subfield.label(class="form-check-label
                            text-muted", style="cursor: not-allowed;",
                            data_bs_toggle="tooltip", data_bs_placement="top",
                            title="Coming Soon") }} {% else %} {{
                            subfield(class="form-check-input",
                            onchange="toggleInputMode()") }} {{
                            subfield.label(class="form-check-label") }} {% endif
                            %}
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Image Path (Hidden by default) -->
                    <div class="mb-3 d-none" id="imagePathGroup">
                        <label for="image_path" class="form-label">
                            {{ form.image_path.label }}
                            <span class="text-danger">*</span>
                        </label>
                        {{ form.image_path }} {% if form.image_path.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.image_path.errors[0] }}
                        </div>
                        {% endif %}
                        <div class="form-text">
                            Enter the absolute path to a local image file.
                        </div>
                    </div>

                    <!-- Input Text -->
                    <div class="mb-3" id="inputTextGroup">
                        <label for="input" class="form-label">
                            {{ form.input.label }}
                            <span class="text-danger">*</span>
                        </label>
                        {{ form.input }} {% if form.input.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.input.errors[0] }}
                        </div>
                        {% endif %}
                        <div class="form-text">
                            Enter your prompt or message for the model.
                        </div>
                    </div>

                    <!-- Optional Parameters - Collapsible -->
                    <div class="accordion mb-3" id="optionalParams">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button
                                    class="accordion-button collapsed"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#collapseOptional"
                                >
                                    Optional Parameters
                                </button>
                            </h2>
                            <div
                                id="collapseOptional"
                                class="accordion-collapse collapse"
                            >
                                <div class="accordion-body">
                                    <div class="row">
                                        <!-- Max Tokens -->
                                        <div class="col-md-4 mb-3">
                                            <label
                                                for="max_tokens"
                                                class="form-label"
                                                >{{ form.max_tokens.label
                                                }}</label
                                            >
                                            {{ form.max_tokens }} {% if
                                            form.max_tokens.errors %}
                                            <div
                                                class="invalid-feedback d-block"
                                            >
                                                {{ form.max_tokens.errors[0] }}
                                            </div>
                                            {% endif %}
                                        </div>

                                        <!-- Temperature -->
                                        <div class="col-md-4 mb-3">
                                            <label
                                                for="temperature"
                                                class="form-label"
                                                >{{ form.temperature.label
                                                }}</label
                                            >
                                            {{ form.temperature }} {% if
                                            form.temperature.errors %}
                                            <div
                                                class="invalid-feedback d-block"
                                            >
                                                {{ form.temperature.errors[0] }}
                                            </div>
                                            {% endif %}
                                            <div class="form-text small">
                                                Higher = more random
                                            </div>
                                        </div>

                                        <!-- Top P -->
                                        <div class="col-md-4 mb-3">
                                            <label
                                                for="top_p"
                                                class="form-label"
                                                >{{ form.top_p.label }}</label
                                            >
                                            {{ form.top_p }} {% if
                                            form.top_p.errors %}
                                            <div
                                                class="invalid-feedback d-block"
                                            >
                                                {{ form.top_p.errors[0] }}
                                            </div>
                                            {% endif %}
                                            <div class="form-text small">
                                                Nucleus sampling
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Metadata -->
                                    <div class="mb-3">
                                        <label for="metadata" class="form-label"
                                            >{{ form.metadata.label }}</label
                                        >
                                        {{ form.metadata }} {% if
                                        form.metadata.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.metadata.errors[0] }}
                                        </div>
                                        {% endif %}
                                        <div class="form-text">
                                            Optional metadata as JSON object
                                        </div>
                                    </div>

                                    <!-- Boolean Options -->
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="form-check">
                                                {{ form.stream }}
                                                <label
                                                    class="form-check-label"
                                                    for="stream"
                                                >
                                                    {{ form.stream.label }}
                                                </label>
                                                <div class="form-text small">
                                                    Stream response as it's
                                                    generated
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <div class="form-check">
                                                {{ form.store }}
                                                <label
                                                    class="form-check-label"
                                                    for="store"
                                                >
                                                    {{ form.store.label }}
                                                </label>
                                                <div class="form-text small">
                                                    Store response for later
                                                    retrieval
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid">
                        <button
                            type="submit"
                            class="btn btn-primary btn-lg"
                            id="submitBtn"
                        >
                            <span class="submit-text">Submit Request</span>
                            <span
                                class="spinner-border spinner-border-sm d-none"
                                role="status"
                                aria-hidden="true"
                            ></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Response Display -->
        {% if response_data %}

        <!-- Response Content -->
        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-check-circle"></i> Response Content {% if
                    response_data._provider %}
                    <small class="float-end"
                        >from {{ response_data._provider.display_name }}</small
                    >
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                {% if response_data._display_schema %}
                <!-- Auto-detected schema display -->
                {# Set all possible variables from display schema #} {% set
                content = response_data._display_schema.content %} {% set
                schema_type = response_data._display_schema.schema_type %} {%
                set columns = response_data._display_schema.columns %} {% set
                rows = response_data._display_schema.rows %} {% set totals =
                response_data._display_schema.totals %} {% include
                response_data._display_schema.template ignore missing %} {% elif
                response_data.output or response_data.candidates %}
                <!-- Fallback: Display raw output -->
                <p class="text-muted">
                    Response received but could not be parsed.
                </p>
                <pre class="content-text">
{{ (response_data.output or response_data.candidates) | tojson(indent=2) }}</pre
                >
                {% else %}
                <p class="text-muted">No output content available</p>
                {% endif %}
            </div>
        </div>

        <!-- Metrics Section -->
        {% if response_data._metrics %}
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Performance Metrics</h5>
            </div>
            <div class="card-body">
                {% set latency_ms = response_data._metrics.latency_ms %} {% set
                latency_seconds = response_data._metrics.latency_seconds %} {%
                set prompt_tokens = response_data._metrics.prompt_tokens %} {%
                set completion_tokens = response_data._metrics.completion_tokens
                %} {% set total_tokens = response_data._metrics.total_tokens %}
                {% set has_token_usage = total_tokens is not none %}

                <div class="metrics-grid">
                    <div class="metric-tile metric-tile-latency">
                        <p class="metric-tile-label">Latency</p>
                        <p class="metric-tile-value">
                            {{ "{:,.0f}".format(latency_ms) }}<span
                                class="metric-tile-unit"
                                >ms</span
                            >
                        </p>
                        <p class="metric-tile-subtext">
                            {{ "{:.2f}".format(latency_seconds) }}s
                        </p>
                    </div>
                    <div class="metric-tile metric-tile-total">
                        <p class="metric-tile-label">Total Tokens</p>
                        {% if has_token_usage %}
                        <p class="metric-tile-value">
                            {{ "{:,}".format(total_tokens) }}
                        </p>
                        {% else %}
                        <p class="metric-tile-subtext">Not available</p>
                        {% endif %}
                    </div>
                    <div class="metric-tile metric-tile-prompt">
                        <p class="metric-tile-label">Prompt Tokens</p>
                        {% if has_token_usage %}
                        <p class="metric-tile-value">
                            {{ "{:,}".format(prompt_tokens or 0) }}
                        </p>
                        {% else %}
                        <p class="metric-tile-subtext">Not available</p>
                        {% endif %}
                    </div>
                    <div class="metric-tile metric-tile-completion">
                        <p class="metric-tile-label">Completion Tokens</p>
                        {% if has_token_usage %}
                        <p class="metric-tile-value">
                            {{ "{:,}".format(completion_tokens or 0) }}
                        </p>
                        {% else %}
                        <p class="metric-tile-subtext">Not available</p>
                        {% endif %}
                    </div>
                </div>

                <hr />
                <div class="row mt-3">
                    <div class="col-md-12">
                        <h6 class="text-muted mb-3">Request Details</h6>
                        {% if response_data._provider %}
                        <div class="metric-item">
                            <span class="metric-label">Provider:</span>
                            <span class="metric-value">
                                <span class="badge bg-primary"
                                    >{{ response_data._provider.display_name
                                    }}</span
                                >
                            </span>
                        </div>
                        {% endif %}
                        <div class="metric-item">
                            <span class="metric-label">Model:</span>
                            <span class="metric-value"
                                >{{ response_data._metrics.model }}</span
                            >
                        </div>
                        {% if response_data._metrics.created_at_display %}
                        <div class="metric-item">
                            <span class="metric-label">Created At:</span>
                            <span class="metric-value"
                                >{{ response_data._metrics.created_at_display
                                }}</span
                            >
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% if response_data._metrics.output_parameters %}
                <hr />
                <div class="row mt-3">
                    <div class="col-md-12">
                        <h6 class="text-muted mb-3">Output Parameters</h6>
                        {% for param_name, param_value in
                        response_data._metrics.output_parameters.items() %}
                        <div class="metric-item">
                            <span class="metric-label">{{ param_name }}:</span>
                            <span class="metric-value">{{ param_value }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Full JSON Response (Collapsible) -->
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <button
                        class="btn btn-link text-white text-decoration-none p-0"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#fullResponse"
                    >
                        Full JSON Response (Click to expand)
                    </button>
                </h5>
            </div>
            <div id="fullResponse" class="collapse">
                <div class="card-body">
                    <pre
                        class="response-json"
                    ><code>{{ response_data | tojson(indent=2) }}</code></pre>
                </div>
            </div>
        </div>
        {% endif %} {% if error %}
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">Error</h5>
            </div>
            <div class="card-body">
                <p class="mb-0">{{ error }}</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %} {% block scripts %}
<script>
    // Add loading state to submit button
    document.getElementById("apiForm").addEventListener("submit", function (e) {
        const btn = document.getElementById("submitBtn");
        const text = btn.querySelector(".submit-text");
        const spinner = btn.querySelector(".spinner-border");

        text.textContent = "Processing...";
        spinner.classList.remove("d-none");
        btn.disabled = true;
    });

    // Handle Input Mode Toggle
    function toggleInputMode() {
        const mode = document.querySelector(
            'input[name="input_mode"]:checked',
        ).value;
        const textGroup = document.getElementById("inputTextGroup");
        const imageGroup = document.getElementById("imagePathGroup");

        if (mode === "image") {
            textGroup.classList.add("d-none");
            imageGroup.classList.remove("d-none");
        } else {
            textGroup.classList.remove("d-none");
            imageGroup.classList.add("d-none");
        }
    }

    // Initialize toggle state on load
    document.addEventListener("DOMContentLoaded", function () {
        toggleInputMode();

        // Initialize Bootstrap tooltips
        const tooltipTriggerList = [].slice.call(
            document.querySelectorAll('[data-bs-toggle="tooltip"]'),
        );
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}
